generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// AREAS
// ============================================================

model Area {
  id         String    @id @default(uuid())
  name       String
  color      String    @default("#888888")
  sort_order Int       @default(0)
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt

  user_id    String
  user       User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  projects   Project[]

  @@unique([user_id, name])
  @@index([user_id])
  @@map("areas")
}

// ============================================================
// PROJECTS
// ============================================================

enum ProjectStatus {
  ACTIVE
  SOMEDAY
  COMPLETED

  @@map("project_status")
}

enum ProjectType {
  PARALLEL
  SEQUENTIAL

  @@map("project_type")
}

model Project {
  id                   String        @id @default(uuid())
  name                 String
  notes                String?
  status               ProjectStatus @default(ACTIVE)
  type                 ProjectType   @default(PARALLEL)
  sort_order           Int           @default(0)

  // Review
  review_interval_days Int?          @default(7)
  last_reviewed_at     DateTime?
  next_review_date     DateTime?

  // Relations
  user_id              String
  user                 User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  area_id              String
  area                 Area          @relation(fields: [area_id], references: [id], onDelete: Cascade)
  tasks                Task[]

  created_at           DateTime      @default(now())
  updated_at           DateTime      @updatedAt

  @@index([user_id])
  @@index([area_id])
  @@index([status])
  @@index([next_review_date])
  @@map("projects")
}

// ============================================================
// TASKS
// ============================================================

model Task {
  id           String     @id @default(uuid())
  title        String
  notes        String?
  inbox        Boolean    @default(true)
  completed    Boolean    @default(false)
  completed_at DateTime?
  sort_order   Int        @default(0)

  // Dates
  due_date     DateTime?  @db.Date
  defer_date   DateTime?  @db.Date

  // Relations
  user_id      String
  user         User       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  project_id   String?
  project      Project?   @relation(fields: [project_id], references: [id], onDelete: SetNull)
  tags         TaskTag[]
  reminders    Reminder[]

  created_at   DateTime   @default(now())
  updated_at   DateTime   @updatedAt

  @@index([user_id, inbox, completed])
  @@index([user_id, due_date])
  @@index([user_id, defer_date])
  @@index([user_id, completed])
  @@index([project_id])
  @@map("tasks")
}

// ============================================================
// TAGS
// ============================================================

model Tag {
  id         String    @id @default(uuid())
  name       String
  icon       String?
  sort_order Int       @default(0)
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt

  user_id    String
  user       User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  tasks      TaskTag[]

  @@unique([user_id, name])
  @@index([user_id])
  @@map("tags")
}

// Join table for many-to-many Task <-> Tag
model TaskTag {
  task_id String
  tag_id  String
  task    Task   @relation(fields: [task_id], references: [id], onDelete: Cascade)
  tag     Tag    @relation(fields: [tag_id], references: [id], onDelete: Cascade)

  @@id([task_id, tag_id])
  @@map("task_tags")
}

// ============================================================
// REMINDERS
// ============================================================

enum ReminderStatus {
  PENDING
  SENT
  SNOOZED
  DISMISSED

  @@map("reminder_status")
}

model Reminder {
  id            String         @id @default(uuid())
  trigger_at    DateTime
  status        ReminderStatus @default(PENDING)
  snoozed_until DateTime?
  pgboss_job_id String?

  // Relations
  user_id       String
  user          User           @relation(fields: [user_id], references: [id], onDelete: Cascade)
  task_id       String
  task          Task           @relation(fields: [task_id], references: [id], onDelete: Cascade)

  created_at    DateTime       @default(now())
  updated_at    DateTime       @updatedAt

  @@index([user_id, status, trigger_at])
  @@index([task_id])
  @@map("reminders")
}

// ============================================================
// NOTIFICATION SUBSCRIPTIONS
// ============================================================

enum SubscriptionType {
  NTFY
  WEB_PUSH

  @@map("subscription_type")
}

model NotificationSubscription {
  id         String           @id @default(uuid())
  type       SubscriptionType
  active     Boolean          @default(true)

  // ntfy fields
  ntfy_topic String?

  // Web Push fields
  endpoint   String?
  p256dh     String?
  auth       String?

  created_at DateTime         @default(now())
  updated_at DateTime         @updatedAt

  user_id    String
  user       User             @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, type, active])
  @@map("notification_subscriptions")
}

// ============================================================
// USER SESSION (single user)
// ============================================================

model User {
  id            String   @id @default(uuid())
  username      String   @unique
  password_hash String
  created_at    DateTime @default(now())

  sessions               Session[]
  areas                  Area[]
  projects               Project[]
  tasks                  Task[]
  tags                   Tag[]
  reminders              Reminder[]
  notification_subscriptions NotificationSubscription[]

  @@map("users")
}

model Session {
  id         String   @id @default(uuid())
  token      String   @unique
  expires_at DateTime
  user_id    String
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  created_at DateTime @default(now())

  @@index([token])
  @@index([expires_at])
  @@map("sessions")
}
